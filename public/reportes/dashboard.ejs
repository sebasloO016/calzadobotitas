<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Botitas Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    :root {
      --primary:#6a5acd;--secondary:#7b68ee;--bg:#f6f8fc;--white:#fff;
      --text:#2c2c54;--shadow:0 6px 18px rgba(0,0,0,0.08);--soft:#eef0fa;
    }
    *{box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{margin:0;display:flex;background:var(--bg);color:var(--text);min-height:100vh;}

    /* Sidebar */
    .sidebar{width:230px;background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:var(--white);display:flex;flex-direction:column;border-radius:0 20px 20px 0;
      box-shadow:var(--shadow);padding:20px;}
    .sidebar h2{text-align:center;margin-bottom:20px;font-weight:700;}
    .nav-link{display:flex;align-items:center;gap:10px;padding:10px;color:var(--white);
      text-decoration:none;border-radius:8px;margin:4px 0;background:rgba(255,255,255,0.08);
      transition:.3s;}
    .nav-link.active,.nav-link:hover{background:rgba(255,255,255,0.25);transform:translateX(6px);}

    /* Main */
    .main{flex:1;padding:25px 35px;overflow-y:auto;position:relative;}
    header h1{color:var(--primary);font-weight:700;margin:0;}
    header p{color:#777;margin-bottom:60px;}

    /* Filtro global */
    .filter-bar{display:flex;justify-content:space-between;align-items:center;
      background:rgba(255,255,255,.8);backdrop-filter:blur(6px);
      border-radius:15px;box-shadow:var(--shadow);padding:10px 20px;
      position:absolute;top:80px;left:0;right:0;}
    .filter-group{display:flex;align-items:center;gap:10px;}
    .filter-group input{border:1px solid #ccc;border-radius:8px;padding:5px 10px;font-size:.9em;}
    .filter-actions button{border:none;border-radius:8px;padding:8px 14px;font-size:.9em;
      cursor:pointer;color:white;transition:.3s;}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--secondary));}
    .btn-secondary{background:#777;}
    .btn-success{background:linear-gradient(135deg,#28a745,#5dd17a);}
    .btn-danger{background:linear-gradient(135deg,#dc3545,#ff6b6b);}
    .btn-outline-primary{border:1px solid var(--primary);color:var(--primary);background:transparent;}
    .btn-outline-primary:hover{background:var(--primary);color:#fff;}
    .btn-primary:hover,.btn-secondary:hover,.btn-success:hover,.btn-danger:hover{opacity:.85;}

    /* KPI grid */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:18px;margin-top:90px;margin-bottom:30px;}
    .kpi{background:var(--white);border-radius:16px;padding:18px;display:flex;
      align-items:center;justify-content:space-between;box-shadow:var(--shadow);
      transition:.3s;}
    .kpi:hover{transform:translateY(-4px);}
    .kpi-icon{font-size:1.8em;color:var(--primary);background:var(--soft);
      padding:10px;border-radius:12px;}
    .kpi-content h5{margin:0;font-size:.9em;color:#666;}
    .kpi-content p{margin:0;font-size:1.3em;font-weight:700;color:var(--text);}

    /* Charts grid */
    .charts-wrapper{display:grid;grid-template-areas:
        "a b" "c d" "e e" "f g" "h h" "i i";
      gap:25px;}
    .chart-box{background:var(--white);border-radius:16px;padding:20px;
      box-shadow:var(--shadow);transition:.3s;}
    .chart-box:hover{transform:translateY(-3px);}
    .chart-box h4{margin-bottom:10px;color:var(--primary);font-weight:600;}
    .chart-box:nth-child(1){grid-area:a;}
    .chart-box:nth-child(2){grid-area:b;}
    .chart-box:nth-child(3){grid-area:c;}
    .chart-box:nth-child(4){grid-area:d;}
    .chart-box:nth-child(5){grid-area:e;}
    .chart-box:nth-child(6){grid-area:f;}
    .chart-box:nth-child(7){grid-area:g;}
    .chart-box:nth-child(8){grid-area:h;}
    .chart-box:nth-child(9){grid-area:i;}
    @media(max-width:1000px){.charts-wrapper{grid-template-areas:none;grid-template-columns:1fr;}
      .filter-bar{flex-direction:column;gap:10px;position:relative;top:0;margin-bottom:10px;}}
  </style>
</head>
<body>
  <aside class="sidebar">
    <h2>Botitas</h2>
    <a href="/admin-dashboard" class="nav-link"><i class="fas fa-home"></i> Dashboard</a>
    <a href="/inventario" class="nav-link"><i class="fas fa-box"></i> Inventario</a>
    <a href="/clientes" class="nav-link"><i class="fas fa-users"></i> Clientes</a>
    <a href="/proveedores" class="nav-link"><i class="fas fa-truck"></i> Proveedores</a>
    <a href="/ventas/historial" class="nav-link"><i class="fas fa-list"></i> Ventas</a>
    <a href="/reportes" class="nav-link active"><i class="fas fa-chart-line"></i> Reportes</a>
  </aside>

  <main class="main">
    <header>
      <h1>üìä Dashboard Anal√≠tico</h1>
      <p>Analiza ventas, rendimiento y compara per√≠odos espec√≠ficos.</p>
      <div class="filter-bar">
        <div class="filter-group">
          <label>Desde</label><input type="date" id="inicio">
          <label>Hasta</label><input type="date" id="fin">
        </div>
        <div class="filter-actions">
          <button id="aplicar" class="btn-primary"><i class="fas fa-filter"></i> Filtrar</button>
          <button id="reset" class="btn-secondary"><i class="fas fa-sync"></i> Reset</button>
          <button id="excel" class="btn-success"><i class="fas fa-file-excel"></i> Excel</button>
          <button id="pdf" class="btn-danger"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
      </div>
    </header>

    <!-- KPIs din√°micos -->
    <section class="kpi-grid">
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div><div><h5>Ventas Totales</h5><p id="ventasTotales">$0</p></div></div>
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-chart-line"></i></div><div><h5>Ganancia Bruta</h5><p id="gananciaBruta">$0</p></div></div>
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-receipt"></i></div><div><h5>Ticket Promedio</h5><p id="ticketPromedio">$0</p></div></div>
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-percent"></i></div><div><h5>IVA Estimado</h5><p id="iva">$0</p></div></div>
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-sync"></i></div><div><h5>Rotaci√≥n</h5><p id="rotacion">0</p></div></div>
      <div class="kpi"><div class="kpi-icon"><i class="fas fa-coins"></i></div><div><h5>Costo Total</h5><p id="costoTotal">$0</p></div></div>
    </section>

    <!-- Gr√°ficos -->
    <section class="charts-wrapper">
      <div class="chart-box"><h4>Ventas por Mes</h4><canvas id="ventasMes"></canvas></div>
      <div class="chart-box"><h4>Ventas por Categor√≠a</h4><canvas id="ventasCategoria"></canvas></div>
      <div class="chart-box"><h4>Clientes Segmento</h4><canvas id="clientesSegmento"></canvas></div>
      <div class="chart-box"><h4>Formas de Pago</h4><canvas id="formasPago"></canvas></div>
      <div class="chart-box"><h4>Top Productos</h4><canvas id="topProductos"></canvas></div>
      <div class="chart-box"><h4>Ventas por Ciudad</h4><canvas id="ventasCiudad"></canvas></div>
      <div class="chart-box"><h4>Stock por Categor√≠a</h4><canvas id="stockCategoria"></canvas></div>
      <div class="chart-box"><h4>Comparativo de Per√≠odos</h4><canvas id="comparativoDias"></canvas></div>

      <!-- Comparador interactivo -->
      <div class="chart-box">
        <h4>üìÖ Comparador de Per√≠odos Interactivo</h4>
        <div class="row g-2 mb-3" style="display:flex;flex-wrap:wrap;gap:10px;">
          <div><label>Periodo A - Inicio</label><input type="date" id="inicioA" class="form-control"></div>
          <div><label>Periodo A - Fin</label><input type="date" id="finA" class="form-control"></div>
          <div><label>Periodo B - Inicio</label><input type="date" id="inicioB" class="form-control"></div>
          <div><label>Periodo B - Fin</label><input type="date" id="finB" class="form-control"></div>
          <div style="align-self:end;"><button id="btnComparar" class="btn-outline-primary"><i class="fas fa-exchange-alt"></i> Comparar</button></div>
        </div>
        <canvas id="comparativoInteractivo"></canvas>
      </div>
    </section>
  </main>

  <script>
    const crear = (id, tipo, labels, data, label, extraData = null) => {
      const ctx = document.getElementById(id);
      return new Chart(ctx, {
        type: tipo,
        data: {
          labels,
          datasets: [{
            label,
            data,
            backgroundColor: ['#6a5acd','#7b68ee','#60a5fa','#34d399','#fcd34d','#ff6b6b']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  // Si hay cantidad de ventas, mostrar tambi√©n esa info
                  if (extraData && extraData[context.dataIndex]) {
                    return ` ${label}: $${context.formattedValue} (${extraData[context.dataIndex]} ventas)`;
                  }
                  return ` ${label}: $${context.formattedValue}`;
                }
              }
            }
          }
        }
      });
    };


    let charts = [], comparativoChart;

    async function cargarDashboard(inicio='', fin='') {
      $('#aplicar').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Filtrando...');
      try {
        const url = inicio && fin ? `/reportes/general?inicio=${inicio}&fin=${fin}` : '/reportes/general';
        const data = await $.getJSON(url);

        // üîπ KPIs din√°micos
        $('#ventasTotales').text(`$${data.kpi.ventasTotales}`);
        $('#gananciaBruta').text(`$${data.kpi.gananciaBruta}`);
        $('#ticketPromedio').text(`$${data.kpi.ticketPromedio}`);
        $('#iva').text(`$${data.kpi.ivaEstimado}`);
        $('#rotacion').text(`${data.rotacionInventario.rotacionPromedio}`);
        $('#costoTotal').text(`$${data.kpi.costoTotal}`);

        // üîπ Gr√°ficos din√°micos
        charts.forEach(c => c.destroy());
        charts = [
          crear('ventasMes','line',data.ventasPorMes.labels,data.ventasPorMes.valores,'Ventas por Mes'),
          crear('ventasCategoria','bar',data.ventasPorCategoria.labels,data.ventasPorCategoria.valores,'Ventas por Categor√≠a'),
          crear('clientesSegmento','doughnut',['Nuevos','Recurrentes'],[data.clientesSegmento.nuevos,data.clientesSegmento.recurrentes],'Clientes'),
          crear('formasPago','pie',data.formasDePago.labels,data.formasDePago.valores,'Formas de Pago'),
          crear('topProductos','bar',data.topProductos.labels,data.topProductos.valores,'Top Productos'),
          crear(
            'ventasCiudad',
            'bar',
            data.ventasPorCiudad.labels,
            data.ventasPorCiudad.valores.map(v => v.total),
            'Ventas por Ciudad',
            data.ventasPorCiudad.valores.map(v => v.cantidadVentas)
          ),

          crear('stockCategoria','bar',data.stockPorCategoria.labels,data.stockPorCategoria.valores,'Stock por Categor√≠a'),
          crear('comparativoDias','radar',
            ['Hoy','Ayer','SemanaActual','SemanaAnterior','MesActual','MesAnterior'],
            [data.comparativo.hoy,data.comparativo.ayer,data.comparativo.semanaActual,
             data.comparativo.semanaAnterior,data.comparativo.mesActual,data.comparativo.mesAnterior],
             'Comparativo de Per√≠odos')
        ];
      } finally {
        $('#aplicar').prop('disabled', false).html('<i class="fas fa-filter"></i> Filtrar');
      }
    }

    // Filtros din√°micos
    $('#aplicar').click(() => cargarDashboard($('#inicio').val(), $('#fin').val()));
    $('#reset').click(() => { $('#inicio').val(''); $('#fin').val(''); cargarDashboard(); });
    $('#excel').click(() => window.open(`/reportes/exportar/excel?inicio=${$('#inicio').val()}&fin=${$('#fin').val()}`));
    $('#pdf').click(() => window.open(`/reportes/exportar/pdf?inicio=${$('#inicio').val()}&fin=${$('#fin').val()}`));

    // Auto update tipo Power BI
    $('#inicio, #fin').on('change', () => {
      const i = $('#inicio').val(), f = $('#fin').val();
      if (i && f) cargarDashboard(i, f);
    });

    cargarDashboard();

    // Comparador interactivo
    $('#btnComparar').click(async () => {
      const a1 = $('#inicioA').val(), a2 = $('#finA').val(), b1 = $('#inicioB').val(), b2 = $('#finB').val();
      if (!a1 || !a2 || !b1 || !b2) return alert('Selecciona ambos rangos.');
      const res = await $.getJSON(`/reportes/comparar?inicioA=${a1}&finA=${a2}&inicioB=${b1}&finB=${b2}`);
      const labels = res.map(r => r.periodo), values = res.map(r => r.total);
      if (comparativoChart) comparativoChart.destroy();
      const ctx = document.getElementById('comparativoInteractivo');
      comparativoChart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Total Ventas', data: values, backgroundColor: ['#6a5acd','#60a5fa'], borderRadius: 8 }] },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => `$${v}` } } } }
      });
    });
  </script>
</body>

</html>
